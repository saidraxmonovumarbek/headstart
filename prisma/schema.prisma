generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String   @id @default(cuid())
  name          String?
  image         String?
  email         String   @unique
  password      String
  role          String   @default("student")
  isSuperAdmin  Boolean  @default(false)
  createdAt     DateTime @default(now())

  // Students relation
  groups        Group[]  @relation("StudentGroups")

  // Teachers relations (2 slots)
  teachingOne   Group[]  @relation("TeacherOne")
  teachingTwo   Group[]  @relation("TeacherTwo")

  notifications Notification[]
  events        Event[]  @relation("UserEvents")
  homeworks Homework[]

  dailyReflections DailyReflection[]
  monthlyGoals     MonthlyGoal[]

  teacherAttendances TeacherAttendance[]
  studentAttendances StudentAttendance[]
  payments Payment[]
}

model Group {
  id           String   @id @default(cuid())
  name         String

  level String? // IELTS | Beginner | Pre-Intermediate | etc

  monthlyPrice Int?

  // Scheduling logic
  dayType      String?   // ODD | EVEN | INTENSIVE | CUSTOM
  customDays   String?   // JSON ["MON","TUE"]
  startTime    String?   // "14:00"
  endTime      String?   // "16:00"

  teacher1     User?    @relation("TeacherOne", fields: [teacher1Id], references: [id])
  teacher1Id   String?

  teacher2     User?    @relation("TeacherTwo", fields: [teacher2Id], references: [id])
  teacher2Id   String?

  students     User[]   @relation("StudentGroups")

  events       Event[]
  homeworks Homework[]

  attendances StudentAttendance[]
  payments Payment[]
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  userEmail String
  createdAt DateTime @default(now())
}

model Notification {
  id        String   @id @default(cuid())
  message   String
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id])
  userId    String
}

model Event {
  id          String   @id @default(cuid())
  title       String
  description String?
  type        String   // GLOBAL | CLASS | PERSONAL | TODO | HABITS | HEALTH | OTHERS

  startTime   DateTime
  endTime     DateTime

  createdAt   DateTime @default(now())

  isGlobal    Boolean  @default(false)

  creator     User     @relation("UserEvents", fields: [creatorId], references: [id])
  creatorId   String

  group       Group?   @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId     String?
}

model Homework {
  id        String   @id @default(cuid())
  content   String
  date      DateTime

  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String

  teacher   User     @relation(fields: [teacherId], references: [id])
  teacherId String

  createdAt DateTime @default(now())
}

model DailyReflection {
  id        String   @id @default(cuid())
  userId    String
  date      String   // format: "YYYY-MM-DD"
  content   String

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model MonthlyGoal {
  id        String   @id @default(cuid())
  userId    String
  month     String   // format: "YYYY-MM"
  goals     String[] // PostgreSQL text array

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, month])
}

model TeacherAttendance {
  id        String   @id @default(cuid())
  teacher   User     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  teacherId String
  date      DateTime
  present   Boolean

  createdAt DateTime @default(now())

  @@index([teacherId, date])
}

model StudentAttendance {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String
  date      DateTime
  present   Boolean

  createdAt DateTime @default(now())

  @@index([studentId, date])
  @@index([groupId, date])
}

model Payment {
  id        String   @id @default(cuid())
  student   User     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  studentId String
  group     Group    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  groupId   String
  month     String   // "2026-02"
  paid      Boolean
  createdAt DateTime @default(now())

  @@index([studentId, month])
}